<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RAON SERVER 사전예약</title>

<style>
:root{
  --bg1:#fff5fb;
  --bg2:#ffe7f5;
  --card:#ffffff;
  --line:rgba(255,105,180,.22);

  --txt:#1b1b1f;
  --mut:rgba(20,20,30,.62);

  --main:#ff4fa3;   /* 메인 핑크 */
  --main2:#ff86c6;  /* 연한 핑크 */
  --ok:#18c37e;
  --warn:#ffb020;
  --bad:#ff4d4d;

  --r:22px;
}

*{
  box-sizing:border-box;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"Pretendard","Noto Sans KR",Arial
}

body{
  margin:0;
  background:
    radial-gradient(circle at 20% 18%, rgba(255,79,163,.22), transparent 55%),
    radial-gradient(circle at 85% 30%, rgba(255,134,198,.22), transparent 55%),
    linear-gradient(180deg, var(--bg1), var(--bg2));
  color:var(--txt);
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  padding:22px;
}

.card{
  width:100%;
  max-width:640px;
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--r);
  padding:28px;
  box-shadow:0 22px 70px rgba(255,79,163,.16);
}

.header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:14px;
  margin-bottom:10px;
}

h1{
  margin:0;
  font-size:30px;
  letter-spacing:.2px;
}

.badge{
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(255,79,163,.28);
  background:linear-gradient(180deg, rgba(255,79,163,.12), rgba(255,134,198,.08));
  font-weight:900;
  font-size:13px;
  white-space:nowrap;
}

.badge b{ color:var(--main); }

.sub{
  color:var(--mut);
  margin:6px 0 18px;
  line-height:1.5;
}

.timer{
  display:flex;
  justify-content:space-between;
  gap:10px;
  margin-bottom:18px;
}

.timebox{
  flex:1;
  background:linear-gradient(180deg, rgba(255,79,163,.08), rgba(255,134,198,.06));
  border:1px solid rgba(255,79,163,.20);
  border-radius:16px;
  padding:14px 12px;
  text-align:center;
}

.num{
  font-size:26px;
  font-weight:950;
  color:#222;
}

.label{
  font-size:12px;
  color:var(--mut);
  margin-top:4px;
  letter-spacing:.6px;
}

.checkbox{
  display:flex;
  gap:10px;
  margin-bottom:14px;
  font-size:14px;
  color:#222;
}

.checkbox input{ transform: translateY(1px); }

button{
  width:100%;
  padding:15px 16px;
  border-radius:16px;
  border:none;
  font-size:16px;
  font-weight:950;
  cursor:pointer;
  background:linear-gradient(180deg, var(--main), var(--main2));
  color:#fff;
  transition:.18s;
  box-shadow:0 14px 34px rgba(255,79,163,.22);
}

button:hover{
  transform:translateY(-2px);
}

button:disabled{
  opacity:.5;
  cursor:not-allowed;
  transform:none;
  box-shadow:none;
}

/* 상태 메시지 */
.status{
  margin-top:12px;
  font-size:13px;
  color:var(--mut);
  line-height:1.45;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.06);
  background:rgba(0,0,0,.02);
}

.status strong{ color:#111; }

.status.ok{
  border-color: rgba(24,195,126,.25);
  background: rgba(24,195,126,.08);
}
.status.ok strong{ color:var(--ok); }

.status.already{
  border-color: rgba(255,176,32,.25);
  background: rgba(255,176,32,.08);
}
.status.already strong{ color:var(--warn); }

.status.fail{
  border-color: rgba(255,77,77,.25);
  background: rgba(255,77,77,.08);
}
.status.fail strong{ color:var(--bad); }

.small{
  margin-top:10px;
  font-size:12px;
  color:rgba(20,20,30,.50);
}
</style>
</head>
<body>

<div class="card">
  <div class="header">
    <div>
      <h1>RAON SERVER</h1>
      <div class="sub">
        2026년 3월 21일 오픈 예정<br>
        많이 기대해주세요!!
      </div>
    </div>

    <div class="badge">
      사전예약 <b id="cnt">-</b>명
    </div>
  </div>

  <div class="timer">
    <div class="timebox">
      <div class="num" id="d">0</div>
      <div class="label">DAYS</div>
    </div>
    <div class="timebox">
      <div class="num" id="h">00</div>
      <div class="label">HOURS</div>
    </div>
    <div class="timebox">
      <div class="num" id="m">00</div>
      <div class="label">MIN</div>
    </div>
    <div class="timebox">
      <div class="num" id="s">00</div>
      <div class="label">SEC</div>
    </div>
  </div>

  <div class="checkbox">
    <input type="checkbox" id="agree">
    <label for="agree">서버 규칙 및 약관에 동의합니다.</label>
  </div>

  <button id="reserveBtn" disabled>사전예약 하기</button>
  <div id="status" class="status" style="display:none;"></div>
  <div class="small">※ 디스코드 승인 후 자동으로 역할이 지급됩니다.</div>
</div>

<script>
// ===== 설정 =====
const OAUTH_START_URL = "https://raon-oauth-bot.onrender.com/auth/discord";
const COUNT_API_URL   = "https://raon-oauth-bot.onrender.com/api/reserve-count";

// ===== 카운트다운 =====
const target = new Date("2026-03-21T00:00:00+09:00").getTime();

function updateTimer(){
  const now = Date.now();
  const diff = target - now;

  if(diff <= 0){
    document.getElementById("d").innerText = "0";
    document.getElementById("h").innerText = "00";
    document.getElementById("m").innerText = "00";
    document.getElementById("s").innerText = "00";
    return;
  }

  const days = Math.floor(diff / (1000*60*60*24));
  const hours = Math.floor((diff % (1000*60*60*24))/(1000*60*60));
  const minutes = Math.floor((diff % (1000*60*60))/(1000*60));
  const seconds = Math.floor((diff % (1000*60))/1000);

  document.getElementById("d").innerText = days;
  document.getElementById("h").innerText = String(hours).padStart(2,'0');
  document.getElementById("m").innerText = String(minutes).padStart(2,'0');
  document.getElementById("s").innerText = String(seconds).padStart(2,'0');
}
setInterval(updateTimer,1000);
updateTimer();

// ===== DOM =====
const agree = document.getElementById("agree");
const btn = document.getElementById("reserveBtn");
const statusEl = document.getElementById("status");
const cntEl = document.getElementById("cnt");

// ===== 체크박스 =====
agree.addEventListener("change",()=>{
  if (btn.dataset.locked === "1") return;
  btn.disabled = !agree.checked;
});

// ===== OAuth 시작 =====
btn.addEventListener("click",()=>{
  window.location.href = OAUTH_START_URL;
});

// ===== 사전예약 인원 불러오기 =====
async function refreshCount(){
  try{
    const r = await fetch(COUNT_API_URL, { cache: "no-store" });
    const j = await r.json();
    if (typeof j.count === "number") cntEl.textContent = String(j.count);
  }catch{
    // 네트워크 에러면 그냥 유지
  }
}
refreshCount();
setInterval(refreshCount, 10000);

// ===== 결과 파라미터 처리 =====
(function handleResult(){
  const params = new URLSearchParams(window.location.search);
  const ok = params.get("ok");
  const already = params.get("already");
  const reason = params.get("reason");

  if (!ok && !already && !reason) return;

  statusEl.style.display = "block";

  if (already === "1") {
    statusEl.className = "status already";
    statusEl.innerHTML = "<strong>이미 사전예약 완료됨</strong><br>디스코드에서 역할이 이미 지급되어 있습니다.";
    agree.checked = true;
    btn.disabled = true;
    btn.dataset.locked = "1";
    btn.innerText = "이미 사전예약 완료";
    return;
  }

  if (ok === "1") {
    statusEl.className = "status ok";
    statusEl.innerHTML = "<strong>사전예약 완료!</strong><br>디스코드에서 역할이 지급되었습니다.";
    agree.checked = true;
    btn.disabled = true;
    btn.dataset.locked = "1";
    btn.innerText = "사전예약 완료";
    // 성공했으면 카운트 바로 갱신
    refreshCount();
    return;
  }

  if (reason === "not_in_guild") {
    statusEl.className = "status fail";
    statusEl.innerHTML = "<strong>서버에 먼저 들어와야 해요</strong><br>디스코드 서버에 입장 후 다시 시도하세요.";
    btn.dataset.locked = "0";
    btn.disabled = !agree.checked;
    return;
  }

  if (ok === "0") {
    statusEl.className = "status fail";
    statusEl.innerHTML = "<strong>사전예약 실패</strong><br>잠시 후 다시 시도하거나 관리자에게 문의하세요.";
    btn.dataset.locked = "0";
    btn.disabled = !agree.checked;
  }
})();
</script>

</body>
</html>
