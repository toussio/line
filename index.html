<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>RAON SERVER 사전예약</title>

<style>
:root{
  --bgA:#ffe9f3;
  --bgB:#fff6fb;

  --card:#ffffff;
  --line:rgba(255,74,154,.18);

  --txt:#121318;
  --mut:rgba(18,19,24,.60);

  --pink:#ff4a9a;
  --pink2:#ff84c1;

  --ok:#14b87a;
  --warn:#ffb020;
  --bad:#ff3b3b;

  --r:24px;
}

*{ box-sizing:border-box; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Pretendard","Noto Sans KR",Arial; }
body{
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:24px;
  color:var(--txt);
  background:
    radial-gradient(circle at 18% 18%, rgba(255,74,154,.22), transparent 55%),
    radial-gradient(circle at 85% 28%, rgba(255,132,193,.22), transparent 55%),
    linear-gradient(180deg, var(--bgA), var(--bgB));
}

.card{
  width:100%;
  max-width:760px;
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--r);
  box-shadow:0 24px 80px rgba(255,74,154,.18);
  padding:28px;
}

.top{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:16px;
  margin-bottom:18px;
}
.title{
  font-size:32px;
  font-weight:900;
  margin:0;
  letter-spacing:.2px;
}
.sub{
  margin-top:8px;
  color:var(--mut);
  line-height:1.55;
  font-size:14px;
}

.badge{
  flex:0 0 auto;
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 14px;
  border-radius:999px;
  border:1px solid rgba(255,74,154,.25);
  background:linear-gradient(180deg, rgba(255,74,154,.10), rgba(255,132,193,.08));
  font-weight:900;
  font-size:13px;
}
.badge b{ color:var(--pink); }

.timer{
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  gap:12px;
  margin:16px 0 16px;
}
.timebox{
  border-radius:18px;
  border:1px solid rgba(255,74,154,.18);
  background:linear-gradient(180deg, rgba(255,74,154,.06), rgba(255,132,193,.05));
  padding:16px 12px;
  text-align:center;
}
.num{
  font-size:28px;
  font-weight:950;
}
.label{
  margin-top:6px;
  font-size:12px;
  letter-spacing:.6px;
  color:var(--mut);
}

.row{
  display:flex;
  align-items:center;
  gap:10px;
  margin:12px 0 14px;
  font-size:14px;
  color:rgba(18,19,24,.82);
}
.row input{ transform: translateY(1px); }

button{
  width:100%;
  border:none;
  border-radius:18px;
  padding:16px 16px;
  font-weight:950;
  font-size:16px;
  cursor:pointer;
  color:#fff;
  background:linear-gradient(180deg, var(--pink), var(--pink2));
  box-shadow:0 16px 40px rgba(255,74,154,.22);
  transition:.18s;
}
button:hover{ transform: translateY(-2px); }
button:disabled{
  opacity:.55;
  cursor:not-allowed;
  transform:none;
  box-shadow:none;
}

.status{
  margin-top:12px;
  border-radius:16px;
  padding:12px 12px;
  font-size:13px;
  line-height:1.45;
  display:none;
}
.status strong{ font-weight:950; }

.status.ok{
  display:block;
  background:rgba(20,184,122,.08);
  border:1px solid rgba(20,184,122,.22);
  color:rgba(18,19,24,.78);
}
.status.ok strong{ color:var(--ok); }

.status.already{
  display:block;
  background:rgba(255,176,32,.10);
  border:1px solid rgba(255,176,32,.22);
  color:rgba(18,19,24,.78);
}
.status.already strong{ color:var(--warn); }

.status.fail{
  display:block;
  background:rgba(255,59,59,.08);
  border:1px solid rgba(255,59,59,.22);
  color:rgba(18,19,24,.78);
}
.status.fail strong{ color:var(--bad); }

.help{
  margin-top:10px;
  font-size:12px;
  color:rgba(18,19,24,.55);
}

@media (max-width:620px){
  .timer{ grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>

<body>
  <div class="card">
    <div class="top">
      <div>
        <h1 class="title">RAON SERVER</h1>
        <div class="sub">
          2026년 3월 21일 오픈 예정<br>
          많이 기대해주세요!!
        </div>
      </div>

      <div class="badge">
        사전예약 <b id="cnt">…</b>명
      </div>
    </div>

    <div class="timer">
      <div class="timebox">
        <div class="num" id="d">0</div>
        <div class="label">DAYS</div>
      </div>
      <div class="timebox">
        <div class="num" id="h">00</div>
        <div class="label">HOURS</div>
      </div>
      <div class="timebox">
        <div class="num" id="m">00</div>
        <div class="label">MIN</div>
      </div>
      <div class="timebox">
        <div class="num" id="s">00</div>
        <div class="label">SEC</div>
      </div>
    </div>

    <div class="row">
      <input type="checkbox" id="agree">
      <label for="agree">서버 규칙 및 약관에 동의합니다.</label>
    </div>

    <button id="reserveBtn" disabled>사전예약 하기</button>
    <div id="status" class="status"></div>
    <div class="help">※ 디스코드 승인 후 자동으로 역할이 지급됩니다.</div>
  </div>

<script>
/* ===== 설정 ===== */
const OAUTH_START_URL = "https://raon-oauth-bot.onrender.com/auth/discord";
const COUNT_API_URL   = "https://raon-oauth-bot.onrender.com/api/reserve-count";

/* ✅ 로컬 잠금키(브라우저 새로고침해도 유지) */
const LS_KEY = "raon_reserved_done";

/* ===== 카운트다운 ===== */
const target = new Date("2026-03-21T00:00:00+09:00").getTime();

function updateTimer(){
  const diff = target - Date.now();
  const dEl = document.getElementById("d");
  const hEl = document.getElementById("h");
  const mEl = document.getElementById("m");
  const sEl = document.getElementById("s");

  if(diff <= 0){
    dEl.textContent = "0";
    hEl.textContent = "00";
    mEl.textContent = "00";
    sEl.textContent = "00";
    return;
  }

  const days = Math.floor(diff / (1000*60*60*24));
  const hours = Math.floor((diff % (1000*60*60*24))/(1000*60*60));
  const minutes = Math.floor((diff % (1000*60*60))/(1000*60));
  const seconds = Math.floor((diff % (1000*60))/1000);

  dEl.textContent = String(days);
  hEl.textContent = String(hours).padStart(2,'0');
  mEl.textContent = String(minutes).padStart(2,'0');
  sEl.textContent = String(seconds).padStart(2,'0');
}
setInterval(updateTimer, 1000);
updateTimer();

/* ===== DOM ===== */
const agree = document.getElementById("agree");
const btn = document.getElementById("reserveBtn");
const statusEl = document.getElementById("status");
const cntEl = document.getElementById("cnt");

/* ===== 체크박스 ===== */
agree.addEventListener("change", () => {
  if (btn.dataset.locked === "1") return;
  btn.disabled = !agree.checked;
});

/* ===== OAuth 시작 ===== */
btn.addEventListener("click", () => {
  window.location.href = OAUTH_START_URL;
});

/* ===== 인원수 불러오기 ===== */
async function refreshCount(){
  try{
    const r = await fetch(COUNT_API_URL, { cache:"no-store" });
    const j = await r.json();
    if (typeof j.count === "number") {
      cntEl.textContent = j.count.toLocaleString("ko-KR");
    }
  }catch(e){
    // CORS/네트워크 실패면 ... 유지
  }
}
refreshCount();
setInterval(refreshCount, 8000);

/* ===== 버튼 잠금(완료 상태) ===== */
function lockDone(text, type, messageHtml){
  btn.disabled = true;
  btn.dataset.locked = "1";
  btn.textContent = text;
  agree.checked = true;

  statusEl.className = "status " + type;
  statusEl.innerHTML = messageHtml;

  // ✅ 브라우저에서도 “이미 완료” 기억
  localStorage.setItem(LS_KEY, "1");
}

/* ===== 결과 파라미터 처리 ===== */
(function handleResult(){
  const params = new URLSearchParams(window.location.search);
  const ok = params.get("ok");
  const already = params.get("already");
  const reason = params.get("reason");

  // ✅ 서버에서 ok/already 안 와도, 내 브라우저에서 이미 완료면 잠금 유지
  if (localStorage.getItem(LS_KEY) === "1") {
    lockDone(
      "이미 사전예약 완료",
      "already",
      "<strong>이미 사전예약 완료됨</strong><br>이 브라우저에서는 사전예약이 완료 상태입니다."
    );
    return;
  }

  if (already === "1") {
    lockDone(
      "이미 사전예약 완료",
      "already",
      "<strong>이미 사전예약 완료됨</strong><br>디스코드에서 역할이 이미 지급되어 있습니다."
    );
    return;
  }

  if (ok === "1") {
    lockDone(
      "사전예약 완료",
      "ok",
      "<strong>사전예약 완료!</strong><br>디스코드에서 역할이 지급되었습니다."
    );
    refreshCount(); // 즉시 카운트 갱신
    return;
  }

  if (reason === "not_in_guild") {
    statusEl.className = "status fail";
    statusEl.style.display = "block";
    statusEl.innerHTML =
      "<strong>디스코드 서버에 먼저 들어와야 해요</strong><br>서버 입장 후 다시 시도해주세요.";

    btn.dataset.locked = "0";
    btn.disabled = !agree.checked;
    return;
  }

  if (ok === "0") {
    statusEl.className = "status fail";
    statusEl.style.display = "block";
    statusEl.innerHTML =
      "<strong>사전예약 실패</strong><br>잠시 후 다시 시도하거나 관리자에게 문의하세요.";

    btn.dataset.locked = "0";
    btn.disabled = !agree.checked;
  }
})();
</script>
</body>
</html>
